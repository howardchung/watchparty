{"version":3,"file":"findCta608Nalus.js","sourceRoot":"","sources":["../../../src/cta/608/findCta608Nalus.ts"],"names":[],"mappings":"AAAA;;;;;;;;;;GAUG;AACH,MAAM,UAAU,eAAe,CAAC,GAAa,EAAE,QAAgB,EAAE,IAAY;IAC5E,IAAI,OAAO,GAAG,CAAC,EAAE,MAAM,GAAG,QAAQ,EAAE,OAAO,GAAG,CAAC,CAAC;IAChD,MAAM,gBAAgB,GAAG,EAAE,CAAC;IAE5B,4CAA4C;IAC5C,MAAM,WAAW,GAAG,CAAC,WAAmB,EAAE,WAAmB,EAAE,GAAa,EAAE,GAAW,EAAE,EAAE;QAC5F,IAAI,WAAW,KAAK,CAAC,IAAI,WAAW,GAAG,CAAC,EAAE,CAAC;YAC1C,OAAO,IAAI,CAAC;QACb,CAAC;QACD,MAAM,WAAW,GAAG,GAAG,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC;QACtC,MAAM,YAAY,GAAG,GAAG,CAAC,SAAS,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC;QAC5C,MAAM,cAAc,GAAG,GAAG,CAAC,SAAS,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC;QAC9C,MAAM,gBAAgB,GAAG,GAAG,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC;QAC/C,OAAO,WAAW,IAAI,GAAG,IAAI,YAAY,IAAI,EAAE,IAAI,cAAc,IAAI,UAAU,IAAI,gBAAgB,IAAI,CAAC,CAAC;IAC1G,CAAC,CAAC;IAEF,OAAO,MAAM,GAAG,QAAQ,GAAG,IAAI,EAAE,CAAC;QACjC,OAAO,GAAG,GAAG,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;QAChC,OAAO,GAAG,GAAG,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,CAAC,GAAG,EAAE,CAAC;QACxC,yCAAyC;QACzC,IAAI,OAAO,KAAK,CAAC,EAAE,CAAC;YACnB,iDAAiD;YACjD,kEAAkE;YAClE,IAAI,GAAG,GAAG,MAAM,GAAG,CAAC,CAAC;YACrB,IAAI,WAAW,GAAG,CAAC,CAAC,CAAC;YACrB,OAAO,GAAG,GAAG,MAAM,GAAG,CAAC,GAAG,OAAO,GAAG,CAAC,EAAE,CAAC,CAAC,6CAA6C;gBACrF,WAAW,GAAG,CAAC,CAAC;gBAChB,IAAI,CAAC,GAAG,GAAG,CAAC;gBACZ,OAAO,CAAC,KAAK,GAAG,EAAE,CAAC;oBAClB,CAAC,GAAG,GAAG,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC;oBACtB,WAAW,IAAI,CAAC,CAAC;oBACjB,GAAG,EAAE,CAAC;gBACP,CAAC;gBACD,IAAI,WAAW,GAAG,CAAC,CAAC;gBACpB,CAAC,GAAG,GAAG,CAAC;gBACR,OAAO,CAAC,KAAK,GAAG,EAAE,CAAC;oBAClB,CAAC,GAAG,GAAG,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC;oBACtB,WAAW,IAAI,CAAC,CAAC;oBACjB,GAAG,EAAE,CAAC;gBACP,CAAC;gBACD,IAAI,WAAW,CAAC,WAAW,EAAE,WAAW,EAAE,GAAG,EAAE,GAAG,CAAC,EAAE,CAAC;oBACrD,wDAAwD;oBACxD,gBAAgB,CAAC,IAAI,CAAC,CAAC,GAAG,EAAE,WAAW,CAAC,CAAC,CAAC;gBAC3C,CAAC;gBACD,GAAG,IAAI,WAAW,CAAC;YACpB,CAAC;QACF,CAAC;QACD,MAAM,IAAI,OAAO,GAAG,CAAC,CAAC;IACvB,CAAC;IACD,OAAO,gBAAgB,CAAC;AACzB,CAAC","sourcesContent":["/**\n * Find CTA-608 NAL units in a video stream\n *\n * @param raw - The DataView to extract the data from\n * @param startPos - The start position of the data\n * @param size - The size of the data\n * @returns The extracted CTA-608 NAL units\n *\n * @group CTA-608\n * @beta\n */\nexport function findCta608Nalus(raw: DataView, startPos: number, size: number): Array<Array<number>> {\n\tlet nalSize = 0, cursor = startPos, nalType = 0;\n\tconst cta608NaluRanges = [];\n\n\t// Check SEI data according to ANSI-SCTE 128\n\tconst isCTA608SEI = (payloadType: number, payloadSize: number, raw: DataView, pos: number) => {\n\t\tif (payloadType !== 4 || payloadSize < 8) {\n\t\t\treturn null;\n\t\t}\n\t\tconst countryCode = raw.getUint8(pos);\n\t\tconst providerCode = raw.getUint16(pos + 1);\n\t\tconst userIdentifier = raw.getUint32(pos + 3);\n\t\tconst userDataTypeCode = raw.getUint8(pos + 7);\n\t\treturn countryCode == 181 && providerCode == 49 && userIdentifier == 1195456820 && userDataTypeCode == 3;\n\t};\n\n\twhile (cursor < startPos + size) {\n\t\tnalSize = raw.getUint32(cursor);\n\t\tnalType = raw.getUint8(cursor + 4) & 31;\n\t\t//console.log(time + \"  NAL \" + nalType);\n\t\tif (nalType === 6) {\n\t\t\t// SEI NAL Unit. The NAL header is the first byte\n\t\t\t//console.log(\"SEI NALU of size \" + nalSize + \" at time \" + time);\n\t\t\tlet pos = cursor + 5;\n\t\t\tlet payloadType = -1;\n\t\t\twhile (pos < cursor + 4 + nalSize - 1) { // The last byte should be rbsp_trailing_bits\n\t\t\t\tpayloadType = 0;\n\t\t\t\tlet b = 255;\n\t\t\t\twhile (b === 255) {\n\t\t\t\t\tb = raw.getUint8(pos);\n\t\t\t\t\tpayloadType += b;\n\t\t\t\t\tpos++;\n\t\t\t\t}\n\t\t\t\tlet payloadSize = 0;\n\t\t\t\tb = 255;\n\t\t\t\twhile (b === 255) {\n\t\t\t\t\tb = raw.getUint8(pos);\n\t\t\t\t\tpayloadSize += b;\n\t\t\t\t\tpos++;\n\t\t\t\t}\n\t\t\t\tif (isCTA608SEI(payloadType, payloadSize, raw, pos)) {\n\t\t\t\t\t//console.log(\"CTA608 SEI \" + time + \" \" + payloadSize);\n\t\t\t\t\tcta608NaluRanges.push([pos, payloadSize]);\n\t\t\t\t}\n\t\t\t\tpos += payloadSize;\n\t\t\t}\n\t\t}\n\t\tcursor += nalSize + 4;\n\t}\n\treturn cta608NaluRanges;\n}\n"]}
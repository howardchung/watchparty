{"version":3,"file":"Cta608Channel.js","sourceRoot":"","sources":["../../../../src/cta/608/Cta608Channel.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n *\n * This code was ported from the dash.js project at:\n *   https://github.com/Dash-Industry-Forum/dash.js/blob/development/externals/cea608-parser.js\n *   https://github.com/Dash-Industry-Forum/dash.js/commit/8269b26a761e0853bb21d78780ed945144ecdd4d#diff-71bc295a2d6b6b7093a1d3290d53a4b2\n *\n * The original copyright appears below:\n *\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2015-2016, DASH Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  1. Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  2. Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport type { CaptionModes } from './CaptionModes.js';\nimport { CaptionScreen } from './CaptionScreen.js';\nimport { CaptionsLogger } from './CaptionsLogger.js';\nimport type { CueHandler } from './CueHandler.js';\nimport type { PACData } from './PACData.js';\nimport type { PenStyles } from './PenStyles.js';\nimport { VerboseLevel } from './VerboseLevel.js';\n\n/**\n * CTA-608 Channel\n *\n * @group CTA-608\n * @beta\n */\nexport class Cta608Channel {\n\tprivate chNr: number;\n\tprivate outputFilter: CueHandler;\n\tprivate mode: CaptionModes;\n\tprivate displayedMemory: CaptionScreen;\n\tprivate nonDisplayedMemory: CaptionScreen;\n\tprivate lastOutputScreen: CaptionScreen;\n\tprivate writeScreen: CaptionScreen;\n\tprivate cueStartTime: number | null;\n\tprivate logger: CaptionsLogger;\n\n\tconstructor(\n\t\tchannelNumber: number,\n\t\toutputFilter: CueHandler,\n\t\tlogger: CaptionsLogger = new CaptionsLogger(),\n\t) {\n\t\tthis.chNr = channelNumber;\n\t\tthis.outputFilter = outputFilter;\n\t\tthis.mode = null;\n\t\tthis.displayedMemory = new CaptionScreen(logger);\n\t\tthis.nonDisplayedMemory = new CaptionScreen(logger);\n\t\tthis.lastOutputScreen = new CaptionScreen(logger);\n\t\tthis.writeScreen = this.displayedMemory;\n\t\tthis.mode = null;\n\t\tthis.cueStartTime = null; // Keeps track of where a cue started.\n\t\tthis.logger = logger;\n\n\t\tthis.logger.log(VerboseLevel.INFO, 'new Cea608Channel(' + this.chNr + ')');\n\t}\n\n\treset(): void {\n\t\tthis.mode = null;\n\t\tthis.displayedMemory.reset();\n\t\tthis.nonDisplayedMemory.reset();\n\t\tthis.lastOutputScreen.reset();\n\t\tthis.outputFilter?.reset?.();\n\t\tthis.writeScreen = this.displayedMemory;\n\t\tthis.mode = null;\n\t\tthis.cueStartTime = null;\n\t}\n\n\tsetPAC(pacData: PACData): void {\n\t\tthis.writeScreen.setPAC(pacData);\n\t}\n\n\tsetBkgData(bkgData: Partial<PenStyles>): void {\n\t\tthis.writeScreen.setBkgData(bkgData);\n\t}\n\n\tsetMode(newMode: CaptionModes): void {\n\t\tif (newMode === this.mode) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.mode = newMode;\n\t\tthis.logger.log(VerboseLevel.INFO, () => 'MODE=' + newMode);\n\t\tif (this.mode === 'MODE_POP-ON') {\n\t\t\tthis.writeScreen = this.nonDisplayedMemory;\n\t\t}\n\t\telse {\n\t\t\tthis.writeScreen = this.displayedMemory;\n\t\t\tthis.writeScreen.reset();\n\t\t}\n\t\tif (this.mode !== 'MODE_ROLL-UP') {\n\t\t\tthis.displayedMemory.setRollUpRows(null);\n\t\t\tthis.nonDisplayedMemory.setRollUpRows(null);\n\t\t}\n\t\tthis.mode = newMode;\n\t}\n\n\tinsertChars(chars: number[]): void {\n\t\tfor (let i = 0; i < chars.length; i++) {\n\t\t\tthis.writeScreen.insertChar(chars[i]);\n\t\t}\n\n\t\tconst screen =\n\t\t\tthis.writeScreen === this.displayedMemory ? 'DISP' : 'NON_DISP';\n\t\tthis.logger.log(\n\t\t\tVerboseLevel.INFO,\n\t\t\t() => screen + ': ' + this.writeScreen.getDisplayText(true),\n\t\t);\n\t\tif (this.mode === 'MODE_PAINT-ON' || this.mode === 'MODE_ROLL-UP') {\n\t\t\tthis.logger.log(\n\t\t\t\tVerboseLevel.TEXT,\n\t\t\t\t() => 'DISPLAYED: ' + this.displayedMemory.getDisplayText(true),\n\t\t\t);\n\t\t\tthis.outputDataUpdate();\n\t\t}\n\t}\n\n\tccRCL(): void {\n\t\t// Resume Caption Loading (switch mode to Pop On)\n\t\tthis.logger.log(VerboseLevel.INFO, 'RCL - Resume Caption Loading');\n\t\tthis.setMode('MODE_POP-ON');\n\t}\n\n\tccBS(): void {\n\t\t// BackSpace\n\t\tthis.logger.log(VerboseLevel.INFO, 'BS - BackSpace');\n\t\tif (this.mode === 'MODE_TEXT') {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.writeScreen.backSpace();\n\t\tif (this.writeScreen === this.displayedMemory) {\n\t\t\tthis.outputDataUpdate();\n\t\t}\n\t}\n\n\tccAOF(): void {\n\t\t// Reserved (formerly Alarm Off)\n\t}\n\n\tccAON(): void {\n\t\t// Reserved (formerly Alarm On)\n\t}\n\n\tccDER(): void {\n\t\t// Delete to End of Row\n\t\tthis.logger.log(VerboseLevel.INFO, 'DER- Delete to End of Row');\n\t\tthis.writeScreen.clearToEndOfRow();\n\t\tthis.outputDataUpdate();\n\t}\n\n\tccRU(nrRows: number | null): void {\n\t\t// Roll-Up Captions-2,3,or 4 Rows\n\t\tthis.logger.log(VerboseLevel.INFO, 'RU(' + nrRows + ') - Roll Up');\n\t\tthis.writeScreen = this.displayedMemory;\n\t\tthis.setMode('MODE_ROLL-UP');\n\t\tthis.writeScreen.setRollUpRows(nrRows);\n\t}\n\n\tccFON(): void {\n\t\t// Flash On\n\t\tthis.logger.log(VerboseLevel.INFO, 'FON - Flash On');\n\t\tthis.writeScreen.setPen({ flash: true });\n\t}\n\n\tccRDC(): void {\n\t\t// Resume Direct Captioning (switch mode to PaintOn)\n\t\tthis.logger.log(VerboseLevel.INFO, 'RDC - Resume Direct Captioning');\n\t\tthis.setMode('MODE_PAINT-ON');\n\t}\n\n\tccTR(): void {\n\t\t// Text Restart in text mode (not supported, however)\n\t\tthis.logger.log(VerboseLevel.INFO, 'TR');\n\t\tthis.setMode('MODE_TEXT');\n\t}\n\n\tccRTD(): void {\n\t\t// Resume Text Display in Text mode (not supported, however)\n\t\tthis.logger.log(VerboseLevel.INFO, 'RTD');\n\t\tthis.setMode('MODE_TEXT');\n\t}\n\n\tccEDM(): void {\n\t\t// Erase Displayed Memory\n\t\tthis.logger.log(VerboseLevel.INFO, 'EDM - Erase Displayed Memory');\n\t\tthis.displayedMemory.reset();\n\t\tthis.outputDataUpdate(true);\n\t}\n\n\tccCR(): void {\n\t\t// Carriage Return\n\t\tthis.logger.log(VerboseLevel.INFO, 'CR - Carriage Return');\n\t\tthis.writeScreen.rollUp();\n\t\tthis.outputDataUpdate(true);\n\t}\n\n\tccENM(): void {\n\t\t// Erase Non-Displayed Memory\n\t\tthis.logger.log(VerboseLevel.INFO, 'ENM - Erase Non-displayed Memory');\n\t\tthis.nonDisplayedMemory.reset();\n\t}\n\n\tccEOC(): void {\n\t\t// End of Caption (Flip Memories)\n\t\tthis.logger.log(VerboseLevel.INFO, 'EOC - End Of Caption');\n\t\tif (this.mode === 'MODE_POP-ON') {\n\t\t\tconst tmp = this.displayedMemory;\n\t\t\tthis.displayedMemory = this.nonDisplayedMemory;\n\t\t\tthis.nonDisplayedMemory = tmp;\n\t\t\tthis.writeScreen = this.nonDisplayedMemory;\n\t\t\tthis.logger.log(\n\t\t\t\tVerboseLevel.TEXT,\n\t\t\t\t() => 'DISP: ' + this.displayedMemory.getDisplayText(),\n\t\t\t);\n\t\t}\n\t\tthis.outputDataUpdate(true);\n\t}\n\n\tccTO(nrCols: number): void {\n\t\t// Tab Offset 1,2, or 3 columns\n\t\tthis.logger.log(VerboseLevel.INFO, 'TO(' + nrCols + ') - Tab Offset');\n\t\tthis.writeScreen.moveCursor(nrCols);\n\t}\n\n\tccMIDROW(secondByte: number): void {\n\t\t// Parse MIDROW command\n\t\tconst styles: Partial<PenStyles> = { flash: false };\n\t\tstyles.underline = secondByte % 2 === 1;\n\t\tstyles.italics = secondByte >= 0x2e;\n\t\tif (!styles.italics) {\n\t\t\tconst colorIndex = Math.floor(secondByte / 2) - 0x10;\n\t\t\tconst colors = [\n\t\t\t\t'white',\n\t\t\t\t'green',\n\t\t\t\t'blue',\n\t\t\t\t'cyan',\n\t\t\t\t'red',\n\t\t\t\t'yellow',\n\t\t\t\t'magenta',\n\t\t\t];\n\t\t\tstyles.foreground = colors[colorIndex];\n\t\t}\n\t\telse {\n\t\t\tstyles.foreground = 'white';\n\t\t}\n\t\tthis.logger.log(VerboseLevel.INFO, 'MIDROW: ' + JSON.stringify(styles));\n\t\tthis.writeScreen.setPen(styles);\n\t}\n\n\toutputDataUpdate(dispatch: boolean = false): void {\n\t\tconst time = this.logger.time;\n\t\tif (time === null) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.outputFilter) {\n\t\t\tif (this.cueStartTime === null && !this.displayedMemory.isEmpty()) {\n\t\t\t\t// Start of a new cue\n\t\t\t\tthis.cueStartTime = time;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (!this.displayedMemory.equals(this.lastOutputScreen)) {\n\t\t\t\t\tthis.outputFilter.newCue(\n\t\t\t\t\t\tthis.cueStartTime!,\n\t\t\t\t\t\ttime,\n\t\t\t\t\t\tthis.lastOutputScreen,\n\t\t\t\t\t);\n\t\t\t\t\tif (dispatch && this.outputFilter.dispatchCue) {\n\t\t\t\t\t\tthis.outputFilter.dispatchCue();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.cueStartTime = this.displayedMemory.isEmpty() ? null : time;\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.lastOutputScreen.copy(this.displayedMemory);\n\t\t}\n\t}\n\n\tcueSplitAtTime(t: number): void {\n\t\tif (this.outputFilter) {\n\t\t\tif (!this.displayedMemory.isEmpty()) {\n\t\t\t\tif (this.outputFilter.newCue) {\n\t\t\t\t\tthis.outputFilter.newCue(this.cueStartTime!, t, this.displayedMemory);\n\t\t\t\t}\n\n\t\t\t\tthis.cueStartTime = t;\n\t\t\t}\n\t\t}\n\t}\n}\n"]}